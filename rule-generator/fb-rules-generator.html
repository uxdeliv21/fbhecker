
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/gh/space10-community/conversational-form@1.0.1/dist/conversational-form.min.js" crossorigin></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.2/styles/default.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.2/styles/default.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.2/highlight.min.js"></script>
</head>

<body>

    <form action="" id="rule-form" cf-form>
        <fieldset cf-questions="Do you want your rule to apply to a specific resource or all resources?" required>
            <label for="all-resource">All resources
            <input type="radio" name="cfc-resources" id="all-resource" value="all-resource">
          </label>
            <label for="specific-resource">Specific resource
            <input type="radio" name="cfc-resources" id="specific-resource" value="specific-resource">
          </label>
        </fieldset>

        <label for="resource">Tell me the resource name? Like 'Users', 'Cities' </label>
        <input type="text" id="resource" name="resource" cf-conditional-cfc-resources="specific-resource">

        <fieldset cf-questions="Ok, great. What operations do you want to allow/deny for this resource?" required>
            <label for="read">Read
            <input type="radio" name="cfc-operations" id="read" value="read">
           </label>

            <label for="write">Write
            <input type="radio" name="cfc-operations" id="write" value="write">
          </label>

            <label for="read-write">Read and Write
            <input type="radio" name="cfc-operations" id="read-write" value="read-write">
          </label>

            <label for="create">Create
            <input type="radio" name="cfc-operations" id="create" value="create">
          </label>

            <label for="get">Get                
            <input type="radio" name="cfc-operations" id="get" value="get">
          </label>

            <label for="list">List
            <input type="radio" name="cfc-operations" id="list" value="list">
           </label>

            <label for="update">Update
            <input type="radio" name="cfc-operations" id="update" value="update">
           </label>

            <label for="delete">Delete
            <input type="radio" name="cfc-operations" id="delete" value="delete">
           </label>
        </fieldset>

        <fieldset cf-questions="Perfect. What do you want to do with this operation?">
            <label for="allow-all">Allow all clients
            <input type="radio" name="cfc-actions" id="allow-all" value="allow-all">
           </label>

            <label for="allow-auth">Allow authenticated clients
            <input type="radio" name="cfc-actions" id="allow-auth" value="allow-auth">
           </label>

            <label for="allow-creator">Allow document creator
            <input type="radio" name="cfc-actions" id="allow-creator" value="allow-creator" cf-conditional-cfc-operations="[^write]">
            </label>

            <label for="allow-role">Allow a user with the given role(s)
              <input type="radio" name="cfc-actions" id="allow-role" value="allow-role">
            </label>

            <label for="deny-all">Deny all clients
              <input type="radio" name="cfc-actions" id="deny-all" value="deny-all">
             </label>
        </fieldset>


        <input type="text" id="roles-data" name="cfc-roles-data" cf-questions="Where is the role data stored? e.g., /<b>roles</b>/$(request.auth.uid) as <pre> roles: {
          alice: &#x22;owner&#x22;,
          bob: &#x22;reader&#x22;,
          david: &#x22;writer&#x22;,
          jane: &#x22;commenter&#x22;
        }</pre> " cf-input-placeholder="Here, you would enter the collection where you stored roles e.g., roles" cf-conditional-cfc-actions="allow-role" />

        <input type="text" id="roles" name="cfc-roles" cf-questions="What role (s) does the client need to have? Enter comma separated roles." cf-input-placeholder="e.g., admin, moderator" cf-conditional-cfc-actions="allow-role" />

        <input type="submit" value="Submit">
    </form>

    <div class="" id="">
        <pre>
          <code id="rule-code" class="JavaScript">
          </code>
        </pre>
        <button class="btn" data-clipboard-action="copy" data-clipboard-target="#rule-code">
          Copy to clipboard
      </button>
        <button class="btn resetbtn">
        Reset
    </button>
    </div>

</body>
<script>
    $("#rule-form").submit(function(e) {
        e.preventDefault();

        $("#rule-form").hide();

        // var str = $("#myInput").val();
        var opList = {
            "allow-all": "if true;",
            "allow-auth": "if request.auth != null;",
            "allow-creator": "if true;// needs implemenation",
            "allow-role": "",
            "deny-all": "if false;"
        };

        var formdata = window.ConversationalForm.getFormData(true);

        var resource = formdata['resource'];

        if (resource === undefined) {
            resource = "{document=**}";
        } else {
            resource = resource + "/{" + resource + "}";
        }

        var op = formdata['cfc-operations'];

        var subject = formdata['cfc-actions'];

        var user_data_path = formdata['cfc-roles-data'];

        var existing_data = "\n\t\tfunction existingData() {\n\t\t   return resource.data; \n\t\t} ";

        var incoming_data = "\n\t\tfunction incomingData() {" +
            "\n\t\t   return request.resource.data;" +
            "\n\t\t}";

        var isAuthorOrAdmin = "\n\t\tfunction isAuthorOrAdmin(userId, article) {" +
            "\n\t\t   let isAuthor = article.author == userId;" +
            "\n\t\t   let isAdmin = exists(/databases/$(database)/documents/admins/$(userId));" +
            "\n\t\t   return isAuthor || isAdmin;" +
            "\n\t\t}"

        var isAdmin = "\n\t\tfunction isAdmin(userId) {" +
            "\n\t\t   return exists(/databases/$(database)/documents/admins/$(userId));" +
            "\n\t\t}";

        var doesUserHaveXAccount = "\n\t\tfunction doesUserHaveXAccount(domain) {" +
            "\n\t\t   domain = domain.replace('.', '\\.');" +
            "\n\t\t   return request.auth.token.email.matches('.*@' + domain + '$â€™)" +
            "\n\t\t      && request.auth.token.email_verified;" +
            "\n\t\t}";


        console.table(user_data_path);

        if (user_data_path !== undefined) {
            var user_data = "\n\t\tfunction getUserData() {" +
                "\n\t\t   return get(/databases/$(database)/documents/" + user_data_path + "/$(request.auth.uid)).data;" +
                "\n\t\t}";

            var roles = formdata['cfc-roles'].split(",");

            roles.forEach(function(element, index) {
                this[index] = "'" + element.trim() + "'";
            }, roles);

            var roles_list = roles.join(",");

            var roles_held_list = {
                "has-any": "hasAny",
                "has-all": "hasAll"
            };
            var roles_held = roles_held_list[formdata['cfc-roles-held']];

            // FIXME: roles held

            opList['allow-role'] = "if getUserData().keys().hasAll([" + roles_list + "]);";
        }

        var action = opList[formdata['cfc-actions']];

        var user_data_rule = user_data !== undefined ? '\n\n\t' + user_data + '\n' : '';

        if (op[0] === 'read-write') {
            var fullOp = "\n\t\t   allow read: " + action + "\n\t\t   allow write: " + action;
        } else {
            var fullOp = "\n\t\t   allow " + op + ": " + action;
        }

        var rule = "service cloud.firestore {\n\tmatch /databases/{database}/documents {\n\t\tmatch /" + resource +
            fullOp +
            "\n\t\t}" +
            user_data_rule +
            "\n\n\t\t// helper functions" +
            "\t\t" + incoming_data +
            "\n\t\t" + existing_data +
            "\n\t\t" + isAuthorOrAdmin +
            "\n\t\t" + isAdmin +
            "\n\t\t" + doesUserHaveXAccount +
            "\n\t}\n}";

        console.table(rule);

        $("#rule-code").html(rule);
        document.querySelectorAll('pre code').forEach((block) => {
            hljs.highlightBlock(block);
        });

        $(".resetbtn").click(function() {
            location.reload();
        });

    });
</script>
<script>
    hljs.initHighlightingOnLoad();
    new ClipboardJS('.btn');
</script>


</html>